name: SecurityPipeline

on:
  push:
    branches:
      - main

jobs:
  horusec-security:
    name: horusec-security
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
        env:
          GITHUB_TOKEN: ${{ secrets.TOKEN_SAST }}
      - name: Fetch changed files
        id: get_changed_files
        run: |
          commit_range=$(git log --pretty=format:%H ${{ github.event.before }}..${{ github.sha }} | tac)
          changed_files=""
          for commit in $commit_range; do
            files=$(git diff --name-only $commit~1 $commit)
            changed_files="$changed_files $files"
          done
          changed_files=$(echo $changed_files | tr " " "\n" | sort -u | paste -s -d, -)
          echo "::set-output name=changed_files::$changed_files"
      - name: Run Horusec
        if: steps.get_changed_files.outputs.changed_files != ''
        run: |
          curl -fsSL https://raw.githubusercontent.com/ZupIT/horusec/main/deployments/scripts/install.sh | bash -s latest
          horusec start --config-file-path horusec-config.json --project-path /github/workspace --files ${{ steps.get_changed_files.outputs.changed_files }}
